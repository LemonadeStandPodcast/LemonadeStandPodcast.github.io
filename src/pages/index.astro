---
import BaseHead from '../components/BaseHead.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import { SITE_TITLE, SITE_DESCRIPTION } from '../consts';
import { getCollection } from 'astro:content';
import FormattedDate from '../components/FormattedDate.astro';

const allEpisodes = await getCollection('episodes');
const sortedEpisodes = allEpisodes.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());
const latestEpisode = sortedEpisodes[0];
const recentEpisodes = sortedEpisodes.slice(1, 4);
---

<!doctype html>
<html lang="en">
	<head>
		<BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
		<style>
			.episode-thumbnail {
				width: 100%;
				height: 100%;
				object-fit: cover;
			}
		</style>
	</head>
	<body class="min-h-screen bg-white">
		<Header />
		
		<main class="min-h-screen">
			{latestEpisode && (
				<section class="border-b border-gray-200">
					<div class="container max-w-6xl mx-auto px-4 py-8">
						<div class="text-lime text-xl font-bold mb-4">LATEST EPISODE</div>
						<div class="w-full aspect-video mb-6">
							<iframe
								src={`https://www.youtube.com/embed/${latestEpisode.data.youtubeId}`}
								title={latestEpisode.data.title}
								class="w-full h-full"
								frameborder="0"
								allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
								allowfullscreen
							/>
						</div>
						<div>
							<div class="text-lime font-bold mb-2">#{latestEpisode.data.episodeNumber}</div>
							<h1 class="text-4xl font-bold text-gray-900 mb-4">
								<a href={`/episodes/${latestEpisode.slug}/`} class="hover:text-lime">
									{latestEpisode.data.title}
								</a>
							</h1>
							<p class="text-gray-600 mb-4">
								Recorded on: <FormattedDate date={latestEpisode.data.pubDate} />
							</p>
							<p class="text-lg text-gray-700 mb-6">{latestEpisode.data.description}</p>
							<div class="flex flex-wrap gap-2 mb-6">
								{latestEpisode.data.tags.map((tag) => (
									<a
										href={`/episodes?tag=${tag}`}
										class="bg-lemonade bg-opacity-20 text-gray-800 px-3 py-1 rounded-md text-sm hover:bg-opacity-30 transition-colors"
									>
										{tag}
									</a>
								))}
							</div>
							<a
								href={`/episodes/${latestEpisode.slug}/`}
								class="inline-block bg-lime text-white px-6 py-3 rounded-md hover:bg-opacity-90 transition-colors"
							>
								Watch Episode
							</a>
						</div>
					</div>
				</section>
			)}

			{recentEpisodes.length > 0 && (
				<section class="container max-w-6xl mx-auto px-4 py-12">
					<h2 class="text-2xl font-bold text-gray-900 mb-8">Previous Episodes</h2>
					<div class="grid gap-8">
						{recentEpisodes.map((episode) => (
							<article class="flex flex-col md:flex-row gap-6 bg-white rounded-lg overflow-hidden hover:shadow-md transition-shadow">
								<div class="md:w-48 shrink-0">
									<img
										src={`https://img.youtube.com/vi/${episode.data.youtubeId}/maxresdefault.jpg`}
										alt={episode.data.title}
										class="episode-thumbnail aspect-video"
									/>
								</div>
								<div class="flex-1 p-4">
									<div class="text-lime font-bold mb-1">#{episode.data.episodeNumber}</div>
									<h3 class="text-2xl font-bold text-gray-900 mb-2 hover:text-lime">
										<a href={`/episodes/${episode.slug}/`}>
											{episode.data.title}
										</a>
									</h3>
									<p class="text-gray-600 mb-2">
										Recorded on: <FormattedDate date={episode.data.pubDate} />
									</p>
									<p class="text-gray-700 mb-4 line-clamp-2">
										{episode.data.description}
									</p>
									<div class="flex flex-wrap gap-2">
										{episode.data.tags.map((tag) => (
											<a 
												href={`/episodes?tag=${tag}`}
												class="bg-lemonade bg-opacity-20 text-gray-800 px-3 py-1 rounded-md text-sm hover:bg-opacity-30 transition-colors"
											>
												{tag}
											</a>
										))}
									</div>
								</div>
							</article>
						))}
					</div>
				</section>
			)}
		</main>
		<Footer />
	</body>
</html>
